<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>FermentLab Tablet</title>
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-elevated: #1a1a24;
      --border: rgba(255, 255, 255, 0.08);
      --accent: #d4a574;
      --accent-glow: rgba(212, 165, 116, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #8b8b9e;
      --success: #4ade80;
      --success-bg: rgba(74, 222, 128, 0.1);
      --danger: #f87171;
      --danger-bg: rgba(248, 113, 113, 0.1);
      --warning: #fbbf24;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 600;
    }

    .header-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--accent);
      border-radius: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .status-dot.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

    .header-time {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 20px;
      padding: 20px;
      height: calc(100vh - 60px);
    }

    /* Left Panel */
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Project Header */
    .project-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .project-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .project-name {
      font-size: 22px;
      font-weight: 600;
    }

    .project-type {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .project-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: var(--success-bg);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      font-size: 13px;
      color: var(--success);
    }

    .project-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    /* State Badge */
    .state-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--success-bg);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--success);
    }

    .state-badge.heating {
      background: rgba(251, 191, 36, 0.1);
      border-color: rgba(251, 191, 36, 0.3);
      color: var(--warning);
    }

    .state-badge.high {
      background: var(--danger-bg);
      border-color: rgba(248, 113, 113, 0.3);
      color: var(--danger);
    }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      flex: 1;
    }

    /* Fermenter Visual */
    .fermenter-card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 2px solid var(--success);
      box-shadow: 0 0 30px rgba(74, 222, 128, 0.15);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .fermenter-header {
      width: 100%;
      margin-bottom: 16px;
    }

    .fermenter-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .fermenter-type {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .fermenter-visual {
      position: relative;
      width: 200px;
      height: 240px;
      margin: 20px 0;
    }

    .fermenter-body {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: 180px;
      background: linear-gradient(180deg, #2a2a35 0%, #1a1a24 100%);
      border-radius: 20px 20px 40px 40px;
      border: 2px solid var(--border);
      overflow: hidden;
    }

    .fermenter-liquid {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70%;
      background: linear-gradient(180deg,
        rgba(212, 165, 116, 0.6) 0%,
        rgba(180, 130, 80, 0.8) 50%,
        rgba(139, 90, 43, 0.9) 100%);
      border-radius: 0 0 38px 38px;
    }

    .fermenter-foam {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(180deg,
        rgba(255, 250, 240, 0.9) 0%,
        rgba(245, 235, 220, 0.7) 100%);
      border-radius: 10px 10px 0 0;
    }

    .fermenter-lid {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 40px;
      background: linear-gradient(180deg, #3a3a45 0%, #2a2a35 100%);
      border-radius: 10px 10px 5px 5px;
      border: 2px solid var(--border);
    }

    .fermenter-airlock {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 30px;
      background: linear-gradient(180deg, #4a4a55 0%, #3a3a45 100%);
      border-radius: 5px 5px 3px 3px;
      border: 2px solid var(--border);
    }

    .fermenter-temp {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 12px 20px;
      border-radius: 12px;
      text-align: center;
    }

    .fermenter-temp-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .fermenter-temp-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 16px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.target { background: rgba(239, 68, 68, 0.15); }
    .stat-icon.duration { background: rgba(59, 130, 246, 0.15); }
    .stat-icon.diff { background: rgba(34, 197, 94, 0.15); }
    .stat-icon.heating { background: rgba(251, 191, 36, 0.15); }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-value.positive { color: var(--success); }
    .stat-value.negative { color: var(--danger); }
    .stat-value.heating { color: var(--warning); }

    /* Right Panel - Control */
    .right-panel {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab.active {
      color: var(--text-primary);
      border-bottom: 2px solid var(--accent);
    }

    /* Control Content */
    .control-content {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Auto Badge */
    .auto-badge {
      align-self: flex-end;
      padding: 6px 16px;
      background: var(--success-bg);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
    }

    .auto-badge.manual {
      background: rgba(139, 139, 158, 0.1);
      border-color: rgba(139, 139, 158, 0.3);
      color: var(--text-secondary);
    }

    /* Temperature Dial */
    .temp-dial {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .dial-ring {
      position: relative;
      width: 180px;
      height: 180px;
    }

    .dial-ring svg {
      transform: rotate(-90deg);
    }

    .dial-bg {
      fill: none;
      stroke: var(--bg-elevated);
      stroke-width: 12;
    }

    .dial-progress {
      fill: none;
      stroke: var(--accent);
      stroke-width: 12;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }

    .dial-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .dial-value {
      font-size: 42px;
      font-weight: 700;
    }

    .dial-unit {
      font-size: 20px;
      color: var(--text-secondary);
    }

    .dial-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Temperature Adjust */
    .temp-adjust {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .temp-btn {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .temp-btn:active {
      transform: scale(0.95);
      background: var(--accent);
      color: var(--bg-dark);
    }

    .apply-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: var(--bg-dark);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .apply-btn:active {
      transform: scale(0.98);
    }

    /* Outlet Control */
    .outlet-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .outlet-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .outlet-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--text-secondary);
      border: 2px solid var(--border);
    }

    .outlet-indicator.on {
      background: var(--danger);
      box-shadow: 0 0 12px var(--danger);
    }

    .outlet-info {
      flex: 1;
    }

    .outlet-name {
      font-size: 14px;
      font-weight: 500;
    }

    .outlet-state {
      font-size: 13px;
    }

    .outlet-state.on { color: var(--danger); }
    .outlet-state.off { color: var(--success); }

    .outlet-btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .outlet-btn:active {
      transform: scale(0.98);
    }

    .outlet-btn.on {
      background: var(--danger-bg);
      border-color: var(--danger);
      color: var(--danger);
    }

    /* Mode Toggle */
    .mode-toggle {
      display: flex;
      gap: 8px;
    }

    .mode-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .mode-btn:active {
      transform: scale(0.98);
    }

    .mode-btn.active {
      background: rgba(212, 165, 116, 0.15);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Project Selector */
    .project-selector {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      padding: 8px;
      background: var(--bg-card);
      border-radius: 30px;
      border: 1px solid var(--border);
    }

    .project-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .project-dot.active {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    /* Loading & Error */
    .loading, .error-state, .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--bg-elevated);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .error-icon, .empty-icon { font-size: 60px; opacity: 0.5; }

    .retry-btn {
      padding: 14px 28px;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .main {
        grid-template-columns: 1fr;
        height: auto;
      }
      .content-grid {
        grid-template-columns: 1fr;
      }
      .fermenter-card {
        max-width: 350px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <p>Chargement...</p>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE_URL = 'http://myfermentlab:30082/api';
    const REFRESH_INTERVAL = 5000;

    // State
    let projects = [];
    let currentProjectIndex = 0;
    let isLoading = true;
    let error = null;
    let targetTemp = 20;
    let activeTab = 'control';

    const app = document.getElementById('app');

    // Fetch projects
    async function fetchProjects() {
      try {
        const response = await fetch(`${API_BASE_URL}/projects`);
        if (!response.ok) throw new Error('Erreur API');
        const data = await response.json();
        projects = data.filter(p => p.status === 'active');
        if (projects.length > 0 && targetTemp === 20) {
          targetTemp = projects[0].targetTemperature;
        }
        error = null;
      } catch (err) {
        error = err.message;
      }
      isLoading = false;
      render();
    }

    // Fetch live temperature
    async function fetchLiveTemp(projectId) {
      try {
        const response = await fetch(`${API_BASE_URL}/projects/${projectId}/live-temperature`);
        if (!response.ok) throw new Error('Erreur');
        const data = await response.json();
        const project = projects.find(p => p.id === projectId);
        if (project) {
          project.currentTemperature = data.temperature;
          if (data.outletChanged) {
            await fetchProjects();
          }
          render();
        }
      } catch (err) {
        console.error('Live temp error:', err);
      }
    }

    // Toggle outlet
    async function toggleOutlet(projectId) {
      try {
        const response = await fetch(`${API_BASE_URL}/projects/${projectId}/outlet/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error('Erreur');
        const data = await response.json();
        const project = projects.find(p => p.id === projectId);
        if (project) {
          project.outletActive = data.outletActive;
          render();
        }
      } catch (err) {
        alert('Erreur: impossible de controler la prise');
      }
    }

    // Update target temperature
    async function updateTargetTemp(projectId) {
      try {
        const response = await fetch(`${API_BASE_URL}/projects/${projectId}/target`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetTemperature: targetTemp })
        });
        if (!response.ok) throw new Error('Erreur');
        const project = projects.find(p => p.id === projectId);
        if (project) {
          project.targetTemperature = targetTemp;
          render();
        }
      } catch (err) {
        alert('Erreur: impossible de modifier la temperature cible');
      }
    }

    // Helpers
    function formatTemp(temp) {
      return temp !== null && temp !== undefined ? temp.toFixed(1) : '--.-';
    }

    function getDuration(startDate) {
      const start = new Date(startDate).getTime();
      const now = Date.now();
      const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      return `${days} jour${days > 1 ? 's' : ''}`;
    }

    function getTempDiff(current, target) {
      if (current === null || current === undefined) return { value: '--', class: '' };
      const diff = current - target;
      return {
        value: (diff >= 0 ? '+' : '') + diff.toFixed(1) + '¬∞C',
        class: Math.abs(diff) <= 0.5 ? 'positive' : diff > 0 ? 'negative' : 'positive'
      };
    }

    function getState(current, target, outletActive) {
      if (current === null || current === undefined) return { text: 'En attente', class: '', icon: '...' };
      const diff = target - current;
      if (Math.abs(diff) <= 0.5) return { text: 'Etat : Stable', class: '', icon: '' };
      if (outletActive) return { text: 'Etat : Chauffage', class: 'heating', icon: '' };
      return { text: 'Etat : Refroidissement', class: 'high', icon: '' };
    }

    function getDialProgress(current, target) {
      // Progress based on how close to target (0-100%)
      if (current === null || current === undefined) return 0;
      const diff = Math.abs(target - current);
      const maxDiff = 5; // 5 degrees = 0%
      return Math.max(0, Math.min(100, (1 - diff / maxDiff) * 100));
    }

    // Render
    function render() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      const dateStr = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });

      if (isLoading) {
        app.innerHTML = `<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>`;
        return;
      }

      if (error) {
        app.innerHTML = `
          <header class="header">
            <div class="header-title">Fermentation en cours</div>
            <div class="header-right">
              <div class="header-status"><span class="status-dot error"></span>Deconnecte</div>
            </div>
          </header>
          <div class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p>Impossible de se connecter au serveur</p>
            <button class="retry-btn" onclick="fetchProjects()">Reessayer</button>
          </div>`;
        return;
      }

      if (projects.length === 0) {
        app.innerHTML = `
          <header class="header">
            <div class="header-title">Fermentation en cours</div>
            <div class="header-right">
              <div class="header-status"><span class="status-dot"></span>Connecte</div>
              <div class="header-time">${dateStr} ${timeStr}</div>
            </div>
          </header>
          <div class="empty-state">
            <div class="empty-icon">üç∫</div>
            <p>Aucun projet actif</p>
          </div>`;
        return;
      }

      const project = projects[currentProjectIndex];
      const state = getState(project.currentTemperature, project.targetTemperature, project.outletActive);
      const diff = getTempDiff(project.currentTemperature, project.targetTemperature);
      const progress = getDialProgress(project.currentTemperature, project.targetTemperature);
      const circumference = 2 * Math.PI * 70;
      const dashoffset = circumference - (progress / 100) * circumference;

      app.innerHTML = `
        <header class="header">
          <div class="header-title">Fermentation en cours</div>
          <div class="header-right">
            <div class="header-status"><span class="status-dot"></span>Connecte</div>
            <div class="header-time">${dateStr} ${timeStr}</div>
          </div>
        </header>

        <main class="main">
          <div class="left-panel">
            <div class="project-header">
              <div class="project-info">
                <div>
                  <div class="project-name">${project.name}</div>
                  <div class="project-type">${project.fermentationType}</div>
                </div>
                <div class="project-status">
                  <span class="dot"></span>
                  Croissance active
                </div>
              </div>
              <div class="state-badge ${state.class}">
                <span>${state.icon}</span> ${state.text}
              </div>
            </div>

            <div class="content-grid">
              <div class="fermenter-card">
                <div class="fermenter-header">
                  <div class="fermenter-name">${project.name}</div>
                  <div class="fermenter-type">${project.fermentationType}</div>
                </div>
                <div class="fermenter-visual">
                  <div class="fermenter-airlock"></div>
                  <div class="fermenter-lid"></div>
                  <div class="fermenter-body">
                    <div class="fermenter-liquid">
                      <div class="fermenter-foam"></div>
                    </div>
                  </div>
                  <div class="fermenter-temp">
                    <div class="fermenter-temp-value">${formatTemp(project.currentTemperature)}¬∞C</div>
                    <div class="fermenter-temp-label">Temp.</div>
                  </div>
                </div>
              </div>

              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon target">üéØ</div>
                  <div class="stat-content">
                    <div class="stat-label">Temp. Cible</div>
                    <div class="stat-value">${project.targetTemperature}¬∞C</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon duration">üìÖ</div>
                  <div class="stat-content">
                    <div class="stat-label">Duree</div>
                    <div class="stat-value">${getDuration(project.startDate)}</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon diff">üìä</div>
                  <div class="stat-content">
                    <div class="stat-label">Ecart</div>
                    <div class="stat-value ${diff.class}">${diff.value}</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon heating">‚ö°</div>
                  <div class="stat-content">
                    <div class="stat-label">Chauffage</div>
                    <div class="stat-value ${project.outletActive ? 'heating' : ''}">${project.outletActive ? 'Actif' : 'Inactif'}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="right-panel">
            <div class="tabs">
              <button class="tab ${activeTab === 'control' ? 'active' : ''}" onclick="activeTab='control';render()">Controle Temperature</button>
              <button class="tab ${activeTab === 'history' ? 'active' : ''}" onclick="activeTab='history';render()">Historique</button>
            </div>

            <div class="control-content">
              <div class="auto-badge ${project.controlMode === 'automatic' ? '' : 'manual'}">
                ${project.controlMode === 'automatic' ? 'AUTO' : 'MANUEL'}
              </div>

              <div class="temp-dial">
                <div class="dial-ring">
                  <svg width="180" height="180">
                    <circle class="dial-bg" cx="90" cy="90" r="70" />
                    <circle class="dial-progress" cx="90" cy="90" r="70"
                      stroke-dasharray="${circumference}"
                      stroke-dashoffset="${dashoffset}" />
                  </svg>
                  <div class="dial-center">
                    <div class="dial-value">${targetTemp}<span class="dial-unit">¬∞C</span></div>
                    <div class="dial-label">Cible</div>
                  </div>
                </div>
              </div>

              <div class="temp-adjust">
                <button class="temp-btn" onclick="targetTemp=Math.round((Math.max(0,targetTemp-0.1))*10)/10;render()">‚àí</button>
                <button class="apply-btn" onclick="updateTargetTemp('${project.id}')">Appliquer</button>
                <button class="temp-btn" onclick="targetTemp=Math.round((Math.min(40,targetTemp+0.1))*10)/10;render()">+</button>
              </div>

              <div class="outlet-section">
                <div class="outlet-status">
                  <div class="outlet-indicator ${project.outletActive ? 'on' : ''}"></div>
                  <div class="outlet-info">
                    <div class="outlet-name">Tapis chauffant</div>
                    <div class="outlet-state ${project.outletActive ? 'on' : 'off'}">
                      ${project.outletActive ? 'Active' : 'Desactive'}
                    </div>
                  </div>
                </div>
                <button class="outlet-btn ${project.outletActive ? 'on' : ''}" onclick="toggleOutlet('${project.id}')">
                  ${project.outletActive ? 'Desactiver' : 'Activer'}
                </button>
              </div>

              <div class="mode-toggle">
                <button class="mode-btn ${project.controlMode === 'automatic' ? 'active' : ''}">
                  ‚öôÔ∏è Auto
                </button>
                <button class="mode-btn ${project.controlMode === 'manual' ? 'active' : ''}">
                  ‚úã Manuel
                </button>
              </div>
            </div>
          </div>
        </main>

        ${projects.length > 1 ? `
          <div class="project-selector">
            ${projects.map((p, i) => `
              <div class="project-dot ${i === currentProjectIndex ? 'active' : ''}"
                onclick="currentProjectIndex=${i};targetTemp=${p.targetTemperature};render()"></div>
            `).join('')}
          </div>
        ` : ''}
      `;
    }

    // Start
    function start() {
      fetchProjects();
      setInterval(fetchProjects, 30000);
      setInterval(() => {
        projects.forEach(p => fetchLiveTemp(p.id));
      }, REFRESH_INTERVAL);
      setInterval(render, 1000);
    }

    start();
  </script>
</body>
</html>
